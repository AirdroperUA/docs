---
id: gnss
title: Плата анти-спуфінгу GNSS на STM32F401 (MAVLink GPS)
sidebar_label: Підключення STM32F401 GNSS board до автопілоту
description: Посібник користувача для плати анти-спуфінгу GNSS на STM32F401 з виходом GPS через MAVLink (GPS_TYPE = MAV) для ArduPilot / ArduPlane.
slug: /gnss
---

# Плата анти-спуфінгу GNSS на STM32F401 (GNSS sanity board)

Ця плата на базі **STM32F401** працює як “розумний фільтр” між GNSS-приймачем та автопілотом: вона аналізує сирі GNSS-дані, виявляє спуфінг / аномалії та віддає в автопілот **GPS через MAVLink (GPS_TYPE = MAV)**.

Ланцюжок підключення:

~~~text
GNSS-приймач  →  STM32F401 анти-спуфінг  →  MAVLink по UART  →  автопілот (ArduPilot / ArduPlane)
~~~

Плата:

- читає дані з GNSS-приймача (NMEA / UBX);
- контролює координати, швидкість, HDOP, кількість супутників, стрибки відстані;
- виявляє підозрілу поведінку (спуфінг, телепорти, неможливі швидкості);
- переходить у **Dead Reckoning (DR)** та не дає автопілоту “повірити” фейковим координатам;
- віддає в автопілот GPS-дані у вигляді **MAVLink GPS** (наприклад `GPS_INPUT` / `HIL_GPS`);
- шле службові повідомлення `STATUSTEXT` для логування у наземній станції (Mission Planner тощо).

---

## 1. Зображення

- Фото плати зверху:

  ![Плата GNSS sanity board (вид зверху)](https://i.imgur.com/XpNyuYL.jpeg)

- Схематичне підключення GNSS → плата → автопілот:

  ![Схема підключення GNSS-плати до автопілота](https://i.imgur.com/DQ7K5Fp.png)

- Налаштування серійного порту в Mission Planner:

  ![Приклад налаштувань SERIAL в Mission Planner](https://i.imgur.com/bd4VYpw.png)

- Налаштування GPS_TYPE = MAV:

  ![Налаштування GPS_TYPE = MAV у Mission Planner](https://i.imgur.com/aMAY6TJ.png)


- Новий пристрій stm32f401 (ONBOARD-COMPUTER) має відображатись у списку після підключення:

  ![Меню вибора пристрою](https://i.imgur.com/vhvtbzx.png)


- Приклад повідомлень STATUSTEXT / логів від STM32F401 (ONBOARD-COMPUTER) :

  ![Повідомлення STATUSTEXT від плати анти-спуфінгу](https://i.imgur.com/HJ75DJM.png)

---

## 2. Інтерфейси плати та пін-аут

Нижче описано типовий пін-аут для STM32F401-плати, який використовується прошивкою анти-спуфінгу.

### 2.1. Живлення

- `5V` / `VIN` – живлення від BEC або 5 V рейки автопілота.
- `GND` – загальна земля (спільна для плати, GNSS та автопілота).

### 2.2. UART від GNSS-приймача

Типово (може відрізнятися у вашій ревізії):

- `GPS_RX` – **RX STM32**, приймає дані з GNSS.  
  В нашому випадку: `A3` (UART2 RX).
- `GPS_TX` – **TX STM32**, до GNSS (для конфігурування).  
  В нашому випадку: `A2` (UART2 TX), може не використовуватися.

Підключення:

~~~text
TX GNSS-приймача  →  GPS_RX (A3)
GND GNSS          →  GND плати
~~~

### 2.3. UART до автопілота (MAVLink)

Це головний канал, через який плата віддає GPS у вигляді MAVLink-пакетів.

- `FC_TX` – **TX STM32 → RX автопілота**.  
  В нашому випадку: `A9` (UART1 TX).
- `FC_RX` – **RX STM32 ← TX автопілота**.  
  В нашому випадку: `A10` (UART1 RX), опціонально (для прийому heartbeat / параметрів).

Підключення (один з варіантів):

~~~text
FC SERIALx_TX  →  FC_RX (A10)     [опціонально, якщо прошивка читає MAVLink від FC]
FC SERIALx_RX  ←  FC_TX (A9)      [обов'язково, сюди летить MAVLink від плати]
FC GND         ↔  GND плати
FC 5V          →  5V/VIN плати     [якщо живите плату від FC]
~~~

### 2.4. USB / debug

- Вбудований **USB STM32F401** використовується як `Serial` для текстових логів:
  - режим DR (DR0/DR1);
  - кількість супутників;
  - HDOP, швидкість, висота;
  - поточні координати.

### 2.5. Світлодіод (LED)

- Стандартний LED на `PC13` використовується для індикації стану:
  - повільне миготіння – нормальний режим (`DR0`);
  - швидке миготіння – підозрілий сигнал / `DR1`.

---

## 3. Підключення плати в системі

### 3.1. Живлення

1. Оберіть стабільне джерело 5 В (BEC / живлення від FC).
2. Підключіть:
   - `5V` → `VIN/5V` плати;
   - `GND` → `GND` плати.
3. Переконайтеся мультиметром, що реально приходить ~5.0 В.

:::tip
Бажано живити плату від тієї ж шини живлення, що й GNSS та автопілот, щоб уникнути “гуляючих” рівнів та проблем із землею.
:::

---

### 3.2. Підключення GNSS-приймача

1. На модулі GNSS знайдіть:
   - `TX` – вихід даних (NMEA/UBX);
   - `GND`.

2. Підключіть:
   - `TX GNSS` → `GPS_RX` (A3) на STM32;
   - `GND GNSS` → `GND` плати.

3. `RX GNSS` → `GPS_TX (A2)` – тільки якщо ваша прошивка конфігурує GNSS; інакше можна не підключати.

:::caution
**Не підключайте GNSS напряму до GPS-порту автопілота** – інакше автопілот обходитиме плату анти-спуфінгу, втрачається сенс всієї логіки перевірок.
:::

---

### 3.3. Підключення до автопілота (MAVLink)

1. Оберіть вільний серійний порт автопілота, наприклад:
   - `SERIAL2` / `TELEM2` чи інший `SERIALx`, який ви не використовуєте для телеметрії.

2. На платі автопілота знайдіть:
   - `TX` (SERIALx_TX);
   - `RX` (SERIALx_RX);
   - `5V`;
   - `GND`.

3. Підключіть:

~~~text
SERIALx_TX (FC)  →  FC_RX (A10)   [якщо потрібен зворотній канал MAVLink до плати]
SERIALx_RX (FC)  ←  FC_TX (A9)    [обов'язково, MAVLink від STM32 до FC]
GND (FC)         ↔  GND плати
5V (FC)          →  5V/VIN плати   [за потреби]
~~~

Якщо прошивка використовує тільки односторонню передачу (STM32 → FC), можна обмежитись лише `FC_TX (A9)` → `SERIALx_RX` і спільною землею.

---

## 4. Налаштування ArduPilot / ArduPlane

### 4.1. Налаштування серійного порту

Припустимо, плата підключена до `SERIAL2` автопілота.

У Mission Planner (або іншому GCS) встановіть:

~~~text
SERIAL2_PROTOCOL = 2   // MAVLink2 (рекомендовано)
SERIAL2_BAUD     = 115 // 115200 baud
~~~

Якщо прошивка плати працює на MAVLink1 – використовуйте:

~~~text
SERIAL2_PROTOCOL = 1   // MAVLink1
~~~

Замість `SERIAL2` використовуйте той `SERIALx`, до якого фактично підключена плата.

---

### 4.2. Налаштування GPS як MAVLink (GPS_TYPE)

У параметрах GPS:

~~~text
GPS_TYPE = 14   // MAV (GPS по MAVLink)
~~~

Якщо використовується додатковий фізичний GPS:

~~~text
GPS_TYPE2      = 1 або 2 або 0   // залежно від типу другого GPS (Ublox, Auto тощо)
GPS_AUTO_SWITCH = 1              // автоперемикання між GPS
~~~

При бажанні можна задати пріоритет GPS:

~~~text
GPS_PRIMARY = 1   // наприклад, робити MAVLink-GPS основним
~~~

---

## 5. Логіка роботи прошивки

### 5.1. Нормальний режим (DR0)

У нормальному режимі плата:

1. Приймає дані GNSS (NMEA/UBX) з модуля.
2. Парсить та перевіряє:
   - `fix` (2D/3D);
   - кількість супутників `s`;
   - `HDOP`;
   - швидкість `sp` та курс `crs`;
   - різкість зміни координат (відстань між вимірами).
3. Якщо все в межах порогів:
   - формує MAVLink-пакети з GPS-даними (`GPS_INPUT`, `HIL_GPS` – залежно від реалізації);
   - встановлює правильний `target_system` (зазвичай `1` – sysid автопілота);
   - відправляє GPS по MAVLink на обраний `SERIALx`.
4. Паралельно шле текстові логи на USB (Serial), наприклад:

~~~text
ARM=1 DR=0 SYN=0 BLEND=0 hdop=1.2 latitude : 38.915960
longitude: 34.000511
~~~

LED на `PC13` блимає повільно (нормальний режим).

---

### 5.2. Виявлення спуфінгу / аномальної поведінки

Прошивка моніторить “здоровий глузд”:

- різкий стрибок координат на десятки/сотні км;
- миттєвий переїзд у Південну півкулю (Ліма, Бразилія, Австралія тощо);
- неможлива швидкість (телепорт по швидкості);
- відсутність кореляції між `fix`, кількістю супутників, HDOP.

Коли виявлена аномалія:

1. Плата переходить у режим **Dead Reckoning (`DR1`)** або аналогічний “аварійний” стан.
2. Можливі варіанти поведінки (залежать від вашої версії прошивки):
   - повністю **припиняє відправляти MAVLink GPS**;
   - відправляє “заморожені” останні валідні координати;
   - відправляє координати, розраховані по DR-моделі (якщо реалізовано).
3. В текстових логах на USB ви побачите:

~~~text
ARM=1 DR=1 SYN=0 BLEND=0 hdop=3.2 latitude : 38.915960
longitude: 34.000511
~~~

4. Плата може також відправляти `STATUSTEXT` в автопілот, який видно у Mission Planner:

   - `BC: ENTER DR`
   - `BC: SPOOF JUMP SOUTH`
   - інші службові повідомлення (назви залежать від прошивки).

LED на `PC13` починає блимати швидше (індикатор проблеми).

---

### 5.3. Повернення до нормального режиму

Коли протягом певного часу GNSS знову дає стабільні й адекватні дані, плата:

1. Повертається в `DR0`.
2. Відновлює стандартну відправку GPS по MAVLink.
3. Відправляє `STATUSTEXT` типу `BC: EXIT DR` (залежить від коду).
4. LED повертається до нормального патерну.

---

## 6. Індикація світлодіодом

Типова логіка:

- **Повільне миготіння (~1 раз/сек)** – нормальний режим, GPS ок, `DR0`.
- **Швидке миготіння** – режим DR / спуфінг / немає валідного GPS, `DR1`.
- **Немає миготіння / постійно горить** – немає прошивки, MCU завис, або немає живлення.

---

## 7. Перевірка роботи на столі

### 7.1. Перевірка без автопілота

1. Подайте 5 В на плату.
2. Підключіть GNSS до `GPS_RX` + `GND`.
3. Підключіть USB STM32F401 до ноутбука.
4. Відкрийте Serial Monitor (наприклад 115200 baud).
5. Переконайтеся, що:
   - є рядки з координатами;
   - `DR` = `DR0` при нормальному сигналі;
   - координати близькі до вашої реальної локації.

---

### 7.2. Перевірка режиму DR (симуляція спуфінгу)

1. Подавайте сценарій з телепортом (через GPS-симулятор / hackrf тощо), наприклад:
   - спочатку Київ;
   - потім раптово Ліма або Австралія.
2. Спостерігайте в логах:
   - зміну `DR0` → `DR1`;
   - повідомлення про вхід у DR;
   - зміну патерну LED.
3. Переконайтеся, що після аномалії плата **не віддає “телепортовані” координати** в автопілот.

---

### 7.3. Перевірка з автопілотом

1. Підключіть UART плати до обраного `SERIALx` автопілота.
2. Налаштуйте:

~~~text
SERIALx_PROTOCOL = 2
SERIALx_BAUD     = 115
GPS_TYPE         = 14
~~~

3. Підключіться до Mission Planner:
   - у вкладці `Status` перегляньте поля `gpsstatus`, `gpshdop`, `lat`, `lon`;
   - у `MAVLink Inspector` перевірте, що приходять пакети `GPS_INPUT` / `HIL_GPS`;
   - у `Messages` перегляньте `STATUSTEXT` від sysid плати.
4. При нормальному сигналі:
   - координати в Mission Planner мають бути адекватні;
   - `gpsstatus` вказує на 3D fix.
5. При спуфінгу:
   - або GPS пропадає;
   - або координати не стрибають у Південну півкулю – замість цього плата переходить у DR.

---

## 8. Типові проблеми та їх вирішення

### 8.1. Автопілот не бачить жодного GPS

Перевірте:

- Правильний порт:
  - `SERIALx_PROTOCOL = 2` (або `1` для MAVLink1),
  - `SERIALx_BAUD` відповідає тому, що зашито у платі.
- Підключення проводів:
  - `FC_TX` (STM32 → FC) дійсно йде в `SERIALx_RX` автопілота;
  - спільна земля між платою та FC.
- За потреби тимчасово підключіть USB-UART адаптер до лінії `FC_TX` і перевірте, що там йде потокове MAVLink.

---

### 8.2. MAVLink є, але ArduPilot не визначає GPS

- Переконайтесь, що:
  - `GPS_TYPE = 14` (MAV);
  - плата надсилає саме GPS-пакети (`GPS_INPUT` або `HIL_GPS`), а не лише `STATUSTEXT`.
- Перевірте в `MAVLink Inspector`:
  - `target_system` пакету = sysid автопілота (зазвичай `1`);
  - `lat`, `lon`, `alt`, `satellites_used`, `hdop` мають адекватні значення.

---

### 8.3. Плата весь час у DR, навіть при хорошому сигналі

- Відкрийте текстові логи по USB:
  - гляньте, які значення `fix`, `s`, `hd`, `sp` бачить плата.
- Можливо, пороги у прошивці надто жорсткі:
  - замалі допуски по HDOP;
  - завищені вимоги до мінімальної кількості супутників;
  - надто малий допустимий стрибок відстані.
- Зверніться до підтримки щоб підкоригувати константи в коді та прошити плату повторно.

---

### 8.4. При спуфінгу плата не заходить у DR

- Переконайтеся, що все підключено вірно та виставлені відповідні параметри в мішен планері;
- Спробуйте відключити другий GPS або радіомаяки якщо вони є;

---