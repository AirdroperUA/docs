---
id: gnss_led_status
title: LED-індикація та стани плати
sidebar_label: LED та стани
---

Ця сторінка описує, як плата **GNSS sanity board на STM32F401** сигналізує про свій стан за допомогою вбудованого світлодіода (LED на `PC13`) та як це повʼязано з режимами **DR0 / DR1** і станом GNSS.

---

## 1. Основні стани системи

Плата працює в кількох ключових станах:

- **Нормальний режим (`DR0`)** — GNSS працює адекватно, координати виглядають фізично коректними, немає ознак спуфінгу.
- **Режим Dead Reckoning (`DR1`)** — плата виявила проблему (спуфінг, телепорт, довгий відсутній fix тощо) і блокує/заморожує GPS для автопілота.
- **Немає GNSS** — модуль GNSS не дає валідних даних (немає фреймів, постійний `fix=0`, відсутні супутники).
- **Немає звʼязку з FC** (якщо використовується зворотний канал MAVLink від FC до плати) — немає heartbeat від автопілота.
- **Помилка / MCU не стартував** — живлення є, але прошивка не запустилась коректно (LED не блимає або горить дивно).

---

## 2. Патерни миготіння LED

Нижче наведені **рекомендовані** патерни індикації (як реалізовано в прошивці за замовчуванням ).

| Патерн LED                         | Стан                       | DR-режим | Коментар                                   |
|-----------------------------------|----------------------------|---------|--------------------------------------------|
| Повільне миготіння (~1 раз/сек)   | Нормальна робота GNSS     | `DR0`   | Все ок, координати валідні                |
| Швидке миготіння (~4 рази/сек)    | Виявлено спуфінг / DR     | `DR1`   | Плата заблокувала/заморозила GPS          |
| Подвійний спалах раз на 2–3 сек   | Немає GNSS / немає fix    | `DR1`   | Немає валідних даних від приймача         |
| Постійно вимкнений (при наявній 5 В)| MCU не стартував / немає прошивки | —       | Перевір живлення та прошивку               |
| Постійно горить                   | Внутрішня помилка (assert)| —       | MCU завис, потрібний reset / reflashing   |

> Патерни ми можемо відкоригувати під вашу прошивку, але **важливо мати чітку різницю між DR0 і DR1** — оператор має бачити “здалеку”, що плата перейшла в захисний режим.

---

## 3. Звʼязок LED зі станом DR

У логах по USB ти бачиш рядки типу:

~~~text
fix=3 s=18 hd=0.9 sp=0.0 crs=0.0 alt=176.3 DR0
fix=0 s=19 hd=1.0 sp=0.0 crs=0.0 alt=0.0 DR1
~~~

Поле `DR0` / `DR1` відповідає внутрішньому стану змінної, наприклад:

~~~cpp
enum DrMode : uint8_t {
    DR_MODE_OFF = 0, // DR0
    DR_MODE_ON  = 1  // DR1
};
~~~

Маппінг на LED:

- `DR_MODE_OFF` → повільне миготіння (нормальний режим).
- `DR_MODE_ON`  → швидке миготіння або інший явно “тривожний” патерн.

---

## 4. Коли плата переходить у DR1 (і як це видно по LED)

Плата входить у **DR1**, коли спрацьовує один із тригерів:

- надто великий стрибок відстані між вимірами (`GNSS_MAX_DIST_JUMP_M`);
- неможлива швидкість (`GNSS_MAX_SPEED_MPS` або `GNSS_MAX_SPEED_JUMP`);
- телепорт у Південну півкулю (переїзд через екватор за один апдейт);
- довга відсутність валідного fix (`GNSS_FIX_TIMEOUT_MS`);
- неприпустима якість GNSS (дуже великий HDOP, 0 супутників тощо).

У цей момент:

1. В логах по USB ти бачиш щось на кшталт:

   ~~~text
   SPOOF: DIST JUMP, ENTER DR
   fix=0 s=21 hd=1.0 sp=0.0 crs=0.0 alt=0.0 DR1
   ~~~

2. У Mission Planner в `Messages` зʼявляється `STATUSTEXT`, наприклад:

   ~~~text
   GPS: ENTER DR (jump)
   ~~~

3. LED змінює патерн:
   - з повільного миготіння → на швидке;
   - або на інший явно “алярмовий” режим.

---

## 5. Коли плата повертається у DR0

Плата виходить із DR, коли:

- дані GNSS стабільні певний час (`DR_EXIT_MIN_GOOD_MS`);
- `fix` знову валідний, HDOP у межах, стрибки відстані/швидкості нормальні.

У цей момент:

1. Лог по USB:

   ~~~text
   GPS: EXIT DR
   fix=3 s=18 hd=0.9 sp=0.0 crs=0.0 alt=176.3 DR0
   ~~~

2. У Mission Planner — `STATUSTEXT` типу:

   ~~~text
   GPS: EXIT DR
   ~~~

3. LED повертається до повільного миготіння.

---

## 6. Швидкий “польовий” чек-лист по LED

| Що бачиш на LED                       | Що означає                               | Дії                                      |
|--------------------------------------|------------------------------------------|------------------------------------------|
| Повільно блимає одразу після старту  | Плата стартувала, GNSS ок, DR0           | Можна літати                             |
| Довго немає блимань після подачі 5 В | Немає живлення або MCU не стартував      | Перевір 5 В, GND, прошивку               |
| Одразу швидко блимає                 | Немає GNSS / сильні помилки GNSS         | Перевір проводку GNSS, антени, параметри |
| Після декількох хвилин переходить з повільного на швидке | Виявлено спуфінг / аномалію, DR1 | Перевір логи, відключи/зміни GNSS        |
| LED “завис” у незрозумілому стані    | Можливий crash прошивки                  | Зроби reset, перевір USB-логи            |

---

## 7. Як використовувати LED разом з логами

Рекомендований workflow:

1. **На полі:**
   - дивишся тільки на LED:
     - повільне миготіння → все ок;
     - швидке → є проблема, політ краще не починати / завершити.

2. **В ангарі / офісі:**
   - підключаєш USB;
   - дивишся детальні логи (`fix`, `sats`, `hd`, `DR0/DR1`);
   - аналізуєш, який саме тригер викликав перехід у DR.

3. **Після польоту:**
   - в Mission Planner відкриваєш tlog/bin;
   - дивишся `STATUSTEXT` від плати;
   - по часу співставляєш з тим, що бачила плата (USB-лог) і що бачив автопілот.

Так ти завжди розумітимеш, **чому** LED перейшов в “alarm”-стан і чи це була реальна атака/аномалія, чи просто поганий GNSS.
