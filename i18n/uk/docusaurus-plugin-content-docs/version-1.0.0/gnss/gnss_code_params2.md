---
id: gnss_code_params2
title: Параметри прошивки GNSS sanity board (референс)
sidebar_label: Параметри прошивки
---

Ця сторінка є **довідником по основних константах прошивки** для плати GNSS sanity board на STM32F401.  
Параметри згруповані за призначенням: якість GNSS, логіка DR, таймінги, UART, MAVLink та логування.

> ⚠️ Значення за замовчуванням нижче наведені як приклад.  
> Обовʼязково звірте їх з вашим актуальним файлом `config.h` / вихідним кодом.

---

## 1. Параметри якості GNSS (фізичні пороги)

Ці константи визначають, що вважається **фізично правдоподібним рухом** та **нормальною якістю GNSS**.

### 1.1. Стрибки координат та швидкості

| Параметр                   | Тип   | Дефолт | Опис                                                                                   |
|----------------------------|-------|--------|----------------------------------------------------------------------------------------|
| `GNSS_MAX_DIST_JUMP_M`     | float | 200.0  | Максимально допустимий стрибок відстані між двома послідовними вимірами (м).          |
| `GNSS_MAX_SPEED_JUMP`      | float | 150.0  | Максимально допустима миттєва зміна швидкості між вимірами (м/с).                      |
| `GNSS_MAX_SPEED_MPS`       | float | 120.0  | Фізично максимальна швидкість UAV (м/с). Вище цього значення вважається аномалією.     |
| `GNSS_MAX_ALT_JUMP_M`      | float | 100.0  | Максимально допустимий стрибок висоти між вимірами (м).                               |

**Призначення:** якщо GNSS показує телепорт або надто різке прискорення, вмикається DR/анти-спуфінг.

---

### 1.2. Кількість супутників та HDOP

| Параметр                 | Тип    | Дефолт | Опис                                                                 |
|--------------------------|--------|--------|----------------------------------------------------------------------|
| `GNSS_MIN_SATS_FIX`      | uint16 | 6      | Мінімальна кількість супутників, щоб вважати fix прийнятним.        |
| `GNSS_MIN_SATS_GOOD`     | uint16 | 12     | Кількість супутників, за якої GNSS вважається “гарним”.             |
| `GNSS_MAX_HDOP_GOOD`     | float  | 2.0    | Максимально допустимий HDOP для “гарного” GNSS.                     |

---

### 1.3. Додаткові фільтри

| Параметр                    | Тип   | Дефолт | Опис                                                                       |
|----------------------------|-------|--------|----------------------------------------------------------------------------|
| `GNSS_MIN_GROUND_SPEED_MPS`| float | 0.5    | Швидкість нижче цього значення іноді вважається стоянням / шумом.          |
| `GNSS_SOUTH_HEMI_PROTECT`  | bool  | true   | Якщо `true`, телепорт у Південну півкулю сприймається як безумовний спуфінг.|

---

## 2. Таймінги та логіка DR (Dead Reckoning)

Ці параметри визначають, **коли саме** плата входить у DR (`DR1`) і коли повертається у нормальний режим (`DR0`).

### 2.1. Часові пороги “поганого” GNSS

| Параметр              | Тип    | Дефолт | Опис                                                                                          |
|-----------------------|--------|--------|-----------------------------------------------------------------------------------------------|
| `GNSS_FIX_TIMEOUT_MS` | uint32 | 10000  | Скільки мілісекунд можна чекати валідний fix до визнання GNSS “мертвим”.                      |
| `DR_ENTER_MIN_BAD_MS` | uint32 | 3000   | Мінімальна тривалість “поганого” стану (мало супутників, поганий HDOP, немає fix) для входу в DR. |
| `DR_EXIT_MIN_GOOD_MS` | uint32 | 5000   | Скільки часу GNSS має бути “гарним”, щоб вийти з DR.                                         |

---

### 2.2. Поведінка в DR

(Ці параметри можуть трохи відрізнятися у вашій версії прошивки.)

| Параметр              | Тип    | Дефолт | Опис                                                                                              |
|-----------------------|--------|--------|---------------------------------------------------------------------------------------------------|
| `DR_FREEZE_POSITION`  | bool   | true   | Якщо `true`, координати в DR заморожуються на останньому валідному значенні.                     |
| `DR_MAX_HOLD_TIME_MS` | uint32 | 600000 | Максимальний час, протягом якого дозволено тримати заморожену позицію (після цього GPS може “відвалитись”). |

---

## 3. MAVLink та ідентифікатори системи

### 3.1. Ідентифікація плати та автопілота

| Параметр     | Тип   | Дефолт | Опис                                                                   |
|--------------|-------|--------|------------------------------------------------------------------------|
| `MY_SYSID`   | uint8 | 42     | `sysid` плати GNSS sanity board (джерело MAVLink-повідомлень).        |
| `MY_COMPID`  | uint8 | 191    | `compid` плати (часто `MAV_COMP_ID_ONBOARD_COMPUTER`).                |
| `FC_SYSID`   | uint8 | 1      | Очікуваний `SYSID_THISMAV` автопілота ArduPilot.                      |
| `FC_COMPID`  | uint8 | 1      | Компонент автопілота (`MAV_COMP_ID_AUTOPILOT1`).                       |

> Якщо в ArduPilot змінено `SYSID_THISMAV`, потрібно синхронно змінити `FC_SYSID` у прошивці плати.

### 3.2. Формат GPS-повідомлень

| Параметр                 | Тип  | Дефолт | Опис                                                                 |
|--------------------------|------|--------|----------------------------------------------------------------------|
| `USE_MAVLINK_GPS_INPUT`  | bool | true   | Якщо `true`, використовується `GPS_INPUT`. Якщо `false`, може бути `HIL_GPS`. |

---

## 4. Налаштування UART / серійних портів

Зазвичай задаються в `config.h`:

| Параметр    | Тип    | Дефолт | Опис                                  |
|-------------|--------|--------|---------------------------------------|
| `GNSS_BAUD` | uint32 | 115200 | Швидкість UART для GNSS-приймача.    |
| `FC_BAUD`   | uint32 | 115200 | Швидкість UART для автопілота.       |
| `USB_BAUD`  | uint32 | 115200 | Швидкість USB-порту для логів.       |

Типові макроси вибору портів:

```cpp
#define GNSS_SERIAL   Serial2
#define FC_SERIAL     Serial1
#define USB_SERIAL    Serial
```

---

## 5. Логування та режими debug

### 5.1. Вмикання / вимикання debug-логів

| Параметр              | Тип   | Дефолт     | Опис                                                                 |
|-----------------------|-------|------------|----------------------------------------------------------------------|
| `DEBUG_BUILD`         | macro | закоментовано | Якщо розкоментувати, вмикаються додаткові debug-логи по USB.        |
| `LOG_GNSS_RAW`        | bool  | false      | Якщо `true`, друкуються сирі GNSS-поля для відлагодження.           |
| `LOG_DR_TRANSITIONS`  | bool  | true       | Якщо `true`, кожен перехід DR0 ↔ DR1 логуються та шлються як `STATUSTEXT`. |

Приклад макросів для логування:

```cpp
#define LOGF(fmt, ...)  do { USB_SERIAL.printf(fmt "\r\n", ##__VA_ARGS__); } while (0)
#define LOG(msg)        do { USB_SERIAL.println(msg); } while (0)
```

---

## 6. Рекомендовані значення для різних класів UAV

Нижче — орієнтовні стартові значення, які потрібно підтвердити тестами.

### 6.1. Повільне крило (20–30 м/с)

- `GNSS_MAX_SPEED_MPS` ≈ 60
- `GNSS_MAX_DIST_JUMP_M` ≈ 100
- `GNSS_MAX_ALT_JUMP_M` ≈ 50
- `GNSS_MIN_SATS_GOOD` ≈ 10–12
- `GNSS_MAX_HDOP_GOOD` ≈ 2.0

### 6.2. Тактичний UAV (40–60 м/с)

- `GNSS_MAX_SPEED_MPS` ≈ 120
- `GNSS_MAX_DIST_JUMP_M` ≈ 200–300
- `GNSS_MAX_ALT_JUMP_M` ≈ 100
- Інші пороги можна залишити дефолтними.

### 6.3. Високошвидкісні платформи (>100 м/с)

- `GNSS_MAX_SPEED_MPS` — реальна максимальна швидкість + запас.
- `GNSS_MAX_DIST_JUMP_M` та `GNSS_MAX_ALT_JUMP_M` збільшуються пропорційно.
- Особливо уважно підібрати `GNSS_MAX_SPEED_JUMP`, щоб не ловити false positive при різких маневрах.

---

## 7. Як безпечно змінювати параметри

1. Змінюйте **1–2 параметри за раз**, а не все одразу.
2. Фіксуйте:
   - номер версії прошивки (`gnss_changelog.md`);
   - конкретні значення порогів, з якими запускався тест.
3. Після кожної зміни:
   - зробіть lab-тест (USB-лог + LED);
   - виконайте короткий польотний тест у безпечних умовах.
4. Якщо DR спрацьовує надто часто:
   - поверніться до попередніх значень;
   - проаналізуйте логи та скоригуйте пороги більш обережно.

---

Цей референс не замінює читання вихідного коду, але дає швидке уявлення про основні “ручки”, якими можна налаштувати поведінку GNSS sanity board під ваші платформи та сценарії польотів.
