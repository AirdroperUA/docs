---
id: gnss_ardupilot_integration
title: Тестування плати GNSS sanity board
sidebar_label: Тестування (lab & field)
---

Ця сторінка описує, як протестувати **GNSS sanity board на STM32F401**:

- спочатку на столі (lab-тести);
- потім у полі (flight-тести);
- а також як інтерпретувати логи та типові результати.


---

## 1. Підготовка до тестування

Для базового тесту вам знадобиться:

- плата **GNSS sanity board** з прошивкою;
- GNSS-приймач (F10N/F9P/інший) з UART-виходом;
- автопілот з ArduPilot (або USB-UART адаптер для емуляції MAVLink-каналу);
- джерело живлення 5 В (BEC / лабораторний блок живлення);
- компʼютер з:
  - **Mission Planner** (для тесту з автопілотом);
  - серійним терміналом (для перегляду логів по USB).

---

## 2. Lab-тест №1: базовий запуск без автопілота

Мета: перевірити, що плата стартує, читає GNSS та коректно виводить логи по USB.

### 2.1. Підключення

1. Підключіть GNSS до плати (див. розділ *Підключення (wiring)*):
   - `TX` GNSS → `GPS_RX (A3)`;
   - `GND` спільна;
   - живлення GNSS (5 В або як вимагає модуль).

2. Подавайте на плату 5 В (від BEC або лабораторного БЖ).

3. Підключіть USB плати до ПК.


### 2.2. Очікувана поведінка

1. LED має **повільно миготіти** (режим DR0) після ініціалізації.
2. Відкрийте серійний порт (наприклад, 115200 бод) та переглядайте логи.
3. Ви маєте побачити рядки виду:

~~~text
fix=0 s=3 hd=99.9 sp=0.0 crs=0.0 alt=0.0 DR1
fix=3 s=18 hd=0.9 sp=0.0 crs=0.0 alt=176.3 DR0
~~~

- `fix` — тип фікса (0–3);
- `s` (`sats`) — кількість супутників;
- `hd` (`hdop`) — якість сигналу;
- `DR0` / `DR1` — режим Dead Reckoning.

Якщо плата не показує жодних логів:

- перевірте швидкість порту в терміналі;
- переконайтеся, що плата дійсно стартує (LED моргає);
- перевірте, чи правильно зібрано прошивку.

---

## 3. Lab-тест №2: симуляція відсутності GNSS

Мета: перевірити, що плата переходить у DR при пропаданні GNSS.

### 3.1. Кроки

1. Запустіть стенд як у тесті №1, переконайтеся, що є **нормальні логи** з `DR0`.
2. Відʼєднайте TX GNSS від `GPS_RX` (або вимкніть живлення GNSS).
3. Спостерігайте за LED та логами.

### 3.2. Очікуваний результат

- Через деякий час (`GNSS_FIX_TIMEOUT_MS`, `DR_ENTER_MIN_BAD_MS`) плата має:
  - перейти в **DR1**;
  - надіслати повідомлення в лог, наприклад:

    ~~~text
    GPS: ENTER DR (no fix)
    fix=0 s=0 hd=99.9 sp=0.0 crs=0.0 alt=0.0 DR1
    ~~~

  - змінити патерн LED (з повільного на швидке миготіння).

---

## 4. Lab-тест №3: симуляція “телепорту” / спуфінгу

Мета: перевірити реакцію плати на різкий стрибок координат / швидкості.

Існує два варіанти:

- **апаратний** (через GPS-симулятор, HackRF + gps-sdr-sim);
- **програмний** (якщо ви маєте змогу “підставити” інші координати замість реальних).

Нижче — загальний сценарій.

### 4.1. Підготовка

1. Запустіть стенд, дочекайтеся стабільного `fix=3`, `DR0`.
2. Увімкніть GPS-спуфер / симулятор, який:
   - різко переносить координати (на десятки/сотні км);
   - або різко збільшує швидкість до нереальних значень.

### 4.2. Очікуваний результат

- У логах по USB ви маєте побачити щось на кшталт:

~~~text
SPOOF: DIST JUMP, ENTER DR
fix=0 s=21 hd=1.0 sp=0.0 crs=0.0 alt=0.0 DR1
~~~

- LED переходить у “alarm”-режим (швидке миготіння).
- При поверненні нормального сигналу GNSS:
  - після `DR_EXIT_MIN_GOOD_MS` плата повинна зробити:

    ~~~text
    GPS: EXIT DR
    fix=3 s=18 hd=0.9 sp=0.0 crs=0.0 alt=176.3 DR0
    ~~~

---

## 5. Field-тест №1: короткий політ з нормальним GNSS

Мета: перевірити, що плата не заважає нормальній роботі автопілота та GPS.

### 5.1. Перед польотом

1. Переконайтеся, що:

   - правильно налаштовано `SERIALx_PROTOCOL`, `SERIALx_BAUD`, `GPS_TYPE` (див. розділ *Інтеграція з ArduPilot*);
   - LED поводиться як у нормальному режимі (`DR0`);
   - у Mission Planner видно адекватні `gpsstatus`, `gpshdop`, `gpsnsats`, `lat`, `lng`.

2. Зробіть **arm** і короткий обліт з безпечної смуги.


### 5.2. Після польоту

1. Завантажте **.bin** лог з автопілота.
2. Перегляньте:
   - GPS-треки (чи немає дивних стрибків);
   - `STATUSTEXT` (чи не було `GPS: ENTER DR`).
3. Паралельно перегляньте збережені USB-логи (якщо ви їх писали під час наземних тестів до вильоту).

У нормальних умовах за цей тест:

- DR не повинен вмикатися;
- плата має поводитися прозоро, як звичайний GPS.

---

## 6. Field-тест №2: навмисне погіршення GNSS

Мета: перевірити, як система поводиться, коли GNSS стає поганим у реальному середовищі.

**Увага:** виконуйте тільки в безпечних умовах, з можливістю швидко взяти керування в ручний режим.

### 6.1. Можливі сценарії

1. **Перекриття огляду для GNSS** (наприклад, часткове екранування антени).
2. **Політ поблизу перешкод** (високі будівлі, ліс) — для тесту HDOP та кількості супутників.
3. **Короткочасне вимкнення GNSS-приймача** (якщо це безпечно і не заборонено процедурою).

### 6.2. Очікуваний результат

- При суттєвому погіршенні GNSS плата **може** перейти в DR:
  - у Mission Planner зʼявиться `GPS: ENTER DR (...)`;
  - LED перейде в режим DR1;
  - траєкторія в логах автопілота може частково “замерзнути” (якщо координати заморожуються в DR).

- Після відновлення нормального GNSS:
  - `GPS: EXIT DR`;
  - повернення до `DR0` та нормальної індикації.

---

## 7. Field-тест №3: тест зі спуфінгом (для лабораторних/полігонних умов)

> ⚠️ **Застереження:** використання GPS-спуфінгу в реальному середовищі може бути незаконним або небезпечним. Виконуйте такий тест лише на закритих полігонах / в екранованих умовах згідно із законодавством вашої країни.

Суть тесту:

1. Розгорнути спуфер (HackRF, GPS-симулятор, лабораторне обладнання).
2. Спочатку дати UAV “чистий” GNSS.
3. Потім перевести його в підроблений сигнал (телепорт, зміна швидкості, зміна півкулі).
4. Перевірити, як плата реагує:
   - чи вчасно входить у DR;
   - чи не дає автопілоту “повірити” у фейкові координати;
   - які `STATUSTEXT` та логи зʼявляються.

---

## 8. Аналіз логів

### 8.1. USB-логи плати

Типовий формат рядка:

~~~text
fix=3 s=18 hd=0.9 sp=0.0 crs=0.0 alt=176.3 DR0
~~~

Рекомендовано зберігати їх у файл (через `screen`, `putty`, `minicom` або інші термінали), щоб потім зіставляти з логами автопілота.

### 8.2. Логи автопілота (Mission Planner)

У файлі `.bin` звертайте увагу на:

- поля `GPS` (або `GPA`, `GPB` для кількох GPS);
- повідомлення `STATUSTEXT`;
- події EKF (якщо є попередження по навігації).

Синхронний аналіз **USB-логів плати** та **логів автопілота** дозволяє зрозуміти, чи спрацювали тригери DR вчасно і як це вплинуло на поведінку UAV.

---

## 9. Короткий чек-лист “перед релізом”

Перед тим як вважати плату придатною до бойового/серійного застосування, варто:

- пройти всі **lab-тести** (нормальний режим, відсутність GNSS, симульований спуфінг);
- виконати мінімум кілька **польових тестів**:
  - нормальний політ без DR;
  - політ у складних GNSS-умовах;
  - (за можливості) полігонний тест зі спуфінгом;
- переконатися, що:
  - DR вмикається тільки тоді, коли це дійсно потрібно;
  - DR не заважає нормальній навігації;
  - індикація LED та `STATUSTEXT` зрозумілі для операторів.


